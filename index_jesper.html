<!DOCTYPE html>
<div id="container"></div>

<script src="d3.v7.js"></script>
<!-- Add a slider -->

<p>
    Precision:
    <input
        type="range"
        name="mySlider"
        id="mySlider"
        min="2"
        max="30"
        value="2"
    />
</p>
<!-- Add a tooltip element -->
<div id="tooltip" style="position: absolute; opacity: 0"></div>

<script type="module">
    var tooltip = d3
        .select("body")
        .append("div")
        .attr("id", "tooltip")
        .style("position", "absolute")
        .style("opacity", 0);

    var margin = { top: 50, right: 50, bottom: 50, left: 40 },
        width = 750 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var x = d3.scaleBand().range([0, width]).padding(0.3);
    var y = d3.scaleLinear().range([height, 0]);

    var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Specify the desired IDs to include in the plot
    var desiredIDs = ["3", "4", "5"];

    // Title for the bar chart
    svg.append("text")
        .attr("x", width / 2 - 10)
        .attr("y", height * 1.1)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("font-family", "Helvetica")
        .style("font-weight", "bold") // Add bold style
        .text("Overtakes Count for Selected IDs");

    d3.csv("data/overtakes_with_ids.csv").then(function (data) {
        var filteredData = data.filter(function (d) {
            return desiredIDs.includes(d.ID);
        });
        function updateHistrogram(suck) {
            // Listen to the slider?
            var bins = suck;
            var range = 100;
            var incr = range / bins;

            // Initialize race counts with increments of 5
            var raceCounts = {};
            for (var i = 0; i < range - 1; i += incr) {
                raceCounts[`${Math.round(i)}-${Math.round(i + incr - 1)}`] = 0;
            }
            raceCounts[`${range}++`] = 0;

            filteredData.forEach(function (d) {
                // Find the appropriate range for Overtakes
                for (var i = 0; i < range; i += incr) {
                    if (d.Overtakes >= i && d.Overtakes <= i + incr) {
                        raceCounts[
                            `${Math.round(i)}-${Math.round(i + incr - 1)}`
                        ]++;
                        break; // Break out of the loop once the range is found
                    }
                }
                if (d.Overtakes > range) {
                    console.log(d.Overtakes);
                    console.log(d.range);
                    raceCounts[`${range}++`]++;
                }
            });

            // Now, raceCounts will contain counts for each range of 5 from 0 to 50
            console.log(raceCounts);

            // Create an array of objects for the bar chart
            var barData = Object.keys(raceCounts).map(function (key) {
                return { category: key, count: raceCounts[key] };
            });

            // Define a custom color for the bars
            var barColor = d3
                .scaleOrdinal()
                .domain(
                    barData.map(function (d) {
                        return d.category;
                    })
                )
                .range(["#6277B2"]);

            x.domain(
                barData.map(function (d) {
                    return d.category;
                })
            );
            y.domain([
                0,
                d3.max(barData, function (d) {
                    return d.count;
                }),
            ]);
            svg.selectAll(".bar").remove();
            var maxY = d3.max(barData, function (d) {
                return d.count;
            });
            var bars = svg
                .selectAll(".bar")
                .data(barData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("width", x.bandwidth())
                .attr("y", function (d) {
                    return y(d.count);
                })
                .attr("height", function (d) {
                    return height - y(d.count);
                })
                .attr("x", function (d) {
                    return x(d.category);
                })
                .attr("fill", function (d) {
                    return barColor(d.category);
                })
                .on("mouseover", function (event, d) {
                    // Get mouse position relative to the SVG container
                    var [x, y] = d3.pointer(event);

                    // Show tooltip on mouseover
                    tooltip.transition().duration(200).style("opacity", 0.9);

                    tooltip
                        .html("Range: " + d.category + "<br>Count: " + d.count)
                        .style("left", x + "px")
                        .style("top", y + height * 0.2 + "px"); // Adjust the offset value as needed

                    // Add a horizontal line on the bar
                    svg.append("line")
                        .attr("class", "hover-line")
                        .transition()
                        .duration(300)
                        .style("opacity", 0.9)
                        .attr("x1", 0)
                        .attr("x2", width)
                        .attr("y1", height - (d.count / maxY) * height) // Corrected line
                        .attr("y2", height - (d.count / maxY) * height) // Corrected line
                        .attr("stroke", "red") // You can adjust the color as needed
                        .attr("stroke-width", 2);
                })
                .on("mouseout", function () {
                    // Hide tooltip and remove the horizontal line on mouseout
                    tooltip.transition().duration(500).style("opacity", 0);

                    svg.selectAll(".hover-line").remove();
                });

            svg.selectAll("g").remove();

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .transition()

                .call(d3.axisBottom(x).tickSize(0).tickFormat("")); // This will remove tick labels

            svg.append("g")

                .transition()
                .call(d3.axisLeft(y));

            // Adjust font size for x-axis tick labels
            svg.selectAll(".tick text").style("font-size", "15px");
        }

        function changeRaceList() {
            // Filter data based on desired IDs
            filteredData = data.filter(function (d) {
                return d.ID;
            });
        }
        changeRaceList();
        updateHistrogram(12);
        // Listen to the slider?
        d3.select("#mySlider").on("change", function (d) {
            updateHistrogram(this.value);
        });
    });
</script>

<p>
    Precision:
    <input type="range" name="cunt" id="cunt" min="2" max="30" value="2" />
</p>

<script type="module">
    var tooltip = d3
        .select("body")
        .append("div")
        .attr("id", "tooltip")
        .style("position", "absolute")
        .style("opacity", 0);

    var margin = { top: 50, right: 50, bottom: 50, left: 40 },
        width = 750 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var x = d3.scaleBand().range([0, width]).padding(0.3);
    var y = d3.scaleLinear().range([height, 0]);

    var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Specify the desired IDs to include in the plot
    var desiredIDs = ["3", "4", "5"];

    // Title for the bar chart
    svg.append("text")
        .attr("x", width / 2 - 10)
        .attr("y", height * 1.1)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("font-family", "Helvetica")
        .style("font-weight", "bold") // Add bold style
        .text("Pit stop Count for Selected IDs");

    d3.csv("data/pit_stops_total.csv").then(function (data) {
        var filteredData = data.filter(function (d) {
            return desiredIDs.includes(d.ID);
        });

        function updateHistrogram(suck) {
            // Listen to the slider?
            var bins = suck;
            var range = 180;
            var incr = range / bins;

            // Initialize race counts with increments of 5
            var raceCounts = {};
            for (var i = 0; i < range - 1; i += incr) {
                raceCounts[`${Math.round(i)}-${Math.round(i + incr - 1)}`] = 0;
            }
            raceCounts[`${range}++`] = 0;

            filteredData.forEach(function (d) {
                // Find the appropriate range for Overtakes
                for (var i = 0; i < range; i += incr) {
                    if (d.stop >= i && d.stop <= i + incr) {
                        raceCounts[
                            `${Math.round(i)}-${Math.round(i + incr - 1)}`
                        ]++;
                        break; // Break out of the loop once the range is found
                    }
                }
                if (d.stop > range) {
                    console.log(d.stop);
                    raceCounts[`${range}++`]++;
                }
            });

            // Now, raceCounts will contain counts for each range of 5 from 0 to 50
            console.log(raceCounts);

            // Create an array of objects for the bar chart
            var barData = Object.keys(raceCounts).map(function (key) {
                return { category: key, count: raceCounts[key] };
            });

            // Define a custom color for the bars
            var barColor = d3
                .scaleOrdinal()
                .domain(
                    barData.map(function (d) {
                        return d.category;
                    })
                )
                .range(["#6277B2"]);

            x.domain(
                barData.map(function (d) {
                    return d.category;
                })
            );
            y.domain([
                0,
                d3.max(barData, function (d) {
                    return d.count;
                }),
            ]);
            svg.selectAll(".bar").remove();
            // ... (previous code)

            var maxY = d3.max(barData, function (d) {
                return d.count;
            });
            var bars = svg
                .selectAll(".bar")
                .data(barData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("width", x.bandwidth())
                .attr("y", function (d) {
                    return y(d.count);
                })
                .attr("height", function (d) {
                    return height - y(d.count);
                })
                .attr("x", function (d) {
                    return x(d.category);
                })
                .attr("fill", function (d) {
                    return barColor(d.category);
                })
                .on("mouseover", function (event, d) {
                    // Get mouse position relative to the SVG container
                    var [x, y] = d3.pointer(event);

                    // Show tooltip on mouseover
                    tooltip.transition().duration(200).style("opacity", 0.9);

                    tooltip
                        .html("Range: " + d.category + "<br>Count: " + d.count)
                        .style("left", x + "px")
                        .style("top", y + height * 1.5 + "px"); // Adjust the offset value as needed

                    // Add a horizontal line on the bar
                    svg.append("line")
                        .transition()
                        .duration(300)
                        .style("opacity", 0.9)
                        .attr("class", "hover-line")
                        .attr("x1", 0)
                        .attr("x2", width)
                        .attr("y1", height - (d.count / maxY) * height) // Corrected line
                        .attr("y2", height - (d.count / maxY) * height) // Corrected line
                        .attr("stroke", "red") // You can adjust the color as needed
                        .attr("stroke-width", 2);
                })
                .on("mouseout", function () {
                    // Hide tooltip and remove the horizontal line on mouseout
                    tooltip.transition().duration(500).style("opacity", 0);

                    svg.selectAll(".hover-line").remove();
                });
            svg.selectAll("g").remove();

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .transition()
                .call(d3.axisBottom(x).tickSize(0).tickFormat("")); // This will remove tick labels

            svg.append("g")

                .transition()
                .call(d3.axisLeft(y));

            // Adjust font size for x-axis tick labels
            svg.selectAll(".tick text").style("font-size", "15px");
        }

        function changeRaceList() {
            // Filter data based on desired IDs
            filteredData = data.filter(function (d) {
                return d.raceId;
            });
        }
        changeRaceList();
        updateHistrogram(12);
        // Listen to the slider?
        d3.select("#cunt").on("change", function (d) {
            updateHistrogram(this.value);
        });
    });
</script>
<script type="module">
    // set the dimensions and margins of the graph
    const margin = {
            top: 10,
            right: 10,
            bottom: 10,
            left: 10,
        },
        width = 445 - margin.left - margin.right,
        height = 445 - margin.top - margin.bottom;
    debugger;
    console.log("Setting up SVG");

    // append the svg object to the body of the page
    const svg = d3
        .select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);
    console.log("SVG setup complete");

    // Read data
    d3.csv("data_hierarchy_1level.csv").then(function (data) {
        debugger;
        console.log("Data read successfully", data);

        // stratify the data: reformatting for d3.js
        const root = d3
            .stratify()
            .id(function (d) {
                return d.name;
            })
            .parentId(function (d) {
                return d.parent;
            })(data);
        debugger;
        console.log("Data stratified", root);

        root.sum(function (d) {
            return +d.value;
        }); // Compute the numeric value for each entity
        debugger;
        console.log("Numeric value computed", root);

        // Then d3.treemap computes the position of each element of the hierarchy
        // The coordinates are added to the root object above
        d3.treemap().size([width, height]).padding(4)(root);
        debugger;
        console.log("Treemap layout computed", root);

        // use this information to add rectangles:
        svg.selectAll("rect")
            .data(root.leaves())
            .join("rect")
            .attr("x", function (d) {
                return d.x0;
            })
            .attr("y", function (d) {
                return d.y0;
            })
            .attr("width", function (d) {
                return d.x1 - d.x0;
            })
            .attr("height", function (d) {
                return d.y1 - d.y0;
            })
            .style("stroke", "black")
            .style("fill", "#69b3a2");
        debugger;
        console.log("Rectangles added");

        // and to add the text labels
        svg.selectAll("text")
            .data(root.leaves())
            .join("text")
            .attr("x", function (d) {
                return d.x0 + 10;
            })
            .attr("y", function (d) {
                return d.y0 + 20;
            })
            .text(function (d) {
                return d.data.name;
            })
            .attr("font-size", "15px")
            .attr("fill", "white");
        debugger;
        console.log("Text labels added");
    });
</script>

<script type="module">
    // set the dimensions and margins of the graph
    var margin = { top: 20, right: 20, bottom: 30, left: 40 },
        width = 960 / 2 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    // set the ranges
    var x = d3.scaleBand().range([0, width]).padding(0.8);
    var y = d3.scaleLinear().range([height, 0]);

    // append the svg object to the body of the page
    // append a 'group' element to 'svg'
    // moves the 'group' element to the top left margin
    var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // get the data
    d3.csv("./data/pit_stops_total.csv").then(function (data) {
        // Define the range of valid race_id values
        var validRaceIds = ["0", "1", "2"];

        // Filter the data based on validRaceIds
        var filteredData = data.filter(function (d) {
            return d.raceId;
        });

        data.forEach(function (d) {
            d.stop = +d.stop;
        });
        // Scale the range of the data in the domains using the filtered data
        x.domain(
            filteredData.map(function (d) {
                return d.raceId;
            })
        );
        y.domain([
            0,
            d3.max(filteredData, function (d) {
                return d.stop;
            }),
        ]);

        // append the rectangles for the bar chart
        svg.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", function (d) {
                return x(d.raceId);
            })
            .attr("width", x.bandwidth())
            .attr("y", function (d) {
                return y(d.stop);
            })
            .attr("height", function (d) {
                return height - y(d.stop);
            });

        // add the x Axis
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        // add the y Axis
        svg.append("g").call(d3.axisLeft(y));
    });
</script>

<script type="module">
    import {
        forceSimulation,
        forceCollide,
        forceX,
    } from "https://cdn.jsdelivr.net/npm/d3-force@3/+esm";

    const nodes = [{}, {}];
    const simulation = forceSimulation(nodes)
        .force("x", forceX())
        .force("collide", forceCollide(5))
        .on("tick", () => console.log(nodes[0].x));
</script>
